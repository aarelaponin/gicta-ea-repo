{% extends 'layout.html' %}
{% load crispy_forms_tags %}
{% load i18n %}

{% block content %}
<div class="d-flex flex-column flex-md-row align-items-center pb-2">
    <h2 class="form-title">{% trans "Graph Presets Configuration" %}</h2>
    <div class="d-inline-flex mt-2 mt-md-0 ms-md-auto">
        <div class="btn-group" role="group">
            <form method="POST" action="{% url 'graph_presets_reset' organisation.id %}" style="display: inline;">
                {% csrf_token %}
                <button type="submit" class="btn btn-warning" onclick="return confirm('{% trans "Reset all presets to defaults?" %}')">
                    <i class="fas fa-undo"></i> {% trans "Reset to Defaults" %}
                </button>
            </form>
        </div>
    </div>
</div>

<p class="text-muted">{% trans "Configure preset roles and BDAT layers for the Graph visualization. These presets help architects quickly select relevant element types and relationships." %}</p>

<div class="row">
    <!-- Roles Configuration -->
    <div class="col-md-6">
        <div class="card mb-4">
            <div class="card-header bg-primary text-white">
                <h5 class="mb-0"><i class="fas fa-user-tie"></i> {% trans "Architect Roles" %}</h5>
            </div>
            <div class="card-body">
                <p class="text-muted small">{% trans "Define which element types and relationships each architect role should see by default." %}</p>

                {% for role_id, role in presets.roles.items %}
                <div class="accordion mb-2" id="accordion-role-{{ forloop.counter }}">
                    <div class="accordion-item">
                        <h2 class="accordion-header">
                            <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapse-role-{{ forloop.counter }}">
                                <strong>{{ role.display_name }}</strong>
                            </button>
                        </h2>
                        <div id="collapse-role-{{ forloop.counter }}" class="accordion-collapse collapse" data-bs-parent="#accordion-role-{{ forloop.counter }}">
                            <div class="accordion-body">
                                <p class="text-muted small">{{ role.description }}</p>
                                <div class="mb-2">
                                    <strong>{% trans "Default Element Types:" %}</strong>
                                    <ul class="list-unstyled ms-3">
                                        {% for concept in role.default_concepts %}
                                        <li><i class="fas fa-cube text-primary"></i> {{ concept }}</li>
                                        {% empty %}
                                        <li class="text-muted">{% trans "None configured" %}</li>
                                        {% endfor %}
                                    </ul>
                                </div>
                                <div>
                                    <strong>{% trans "Default Relationship Types:" %}</strong>
                                    <ul class="list-unstyled ms-3">
                                        {% for relation in role.default_relations %}
                                        <li><i class="fas fa-link text-success"></i> {{ relation }}</li>
                                        {% empty %}
                                        <li class="text-muted">{% trans "None configured" %}</li>
                                        {% endfor %}
                                    </ul>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                {% endfor %}
            </div>
        </div>
    </div>

    <!-- Layers Configuration -->
    <div class="col-md-6">
        <div class="card mb-4">
            <div class="card-header bg-success text-white">
                <h5 class="mb-0"><i class="fas fa-layer-group"></i> {% trans "Architecture Layers (BDAT)" %}</h5>
            </div>
            <div class="card-body">
                <p class="text-muted small">{% trans "Define which element types belong to each TOGAF/BDAT layer." %}</p>

                {% for layer_id, layer in presets.layers.items %}
                <div class="accordion mb-2" id="accordion-layer-{{ forloop.counter }}">
                    <div class="accordion-item">
                        <h2 class="accordion-header">
                            <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapse-layer-{{ forloop.counter }}">
                                <span class="badge bg-{% if layer_id == 'business' %}warning{% elif layer_id == 'application' %}info{% elif layer_id == 'data' %}secondary{% else %}dark{% endif %} me-2">{{ layer_id|upper }}</span>
                                <strong>{{ layer.display_name }}</strong>
                            </button>
                        </h2>
                        <div id="collapse-layer-{{ forloop.counter }}" class="accordion-collapse collapse" data-bs-parent="#accordion-layer-{{ forloop.counter }}">
                            <div class="accordion-body">
                                <strong>{% trans "Element Types:" %}</strong>
                                <ul class="list-unstyled ms-3">
                                    {% for concept in layer.concepts %}
                                    <li><i class="fas fa-cube text-primary"></i> {{ concept }}</li>
                                    {% empty %}
                                    <li class="text-muted">{% trans "None configured" %}</li>
                                    {% endfor %}
                                </ul>
                            </div>
                        </div>
                    </div>
                </div>
                {% endfor %}
            </div>
        </div>

        <!-- Auto-Map from Model -->
        <div class="card mb-4">
            <div class="card-header bg-info text-white">
                <h5 class="mb-0"><i class="fas fa-magic"></i> {% trans "Auto-Map from Model" %}</h5>
            </div>
            <div class="card-body">
                <p class="text-muted small">{% trans "Automatically map concepts from a model to BDAT layers based on naming conventions." %}</p>
                <form method="POST" action="" id="auto-map-form">
                    {% csrf_token %}
                    <div class="mb-3">
                        <label for="model-select" class="form-label">{% trans "Select Model" %}</label>
                        <select id="model-select" name="model_id" class="form-select">
                            <option value="">{% trans "Choose a model..." %}</option>
                            {% for model in models %}
                            <option value="{{ model.id }}">{{ model.name }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    <button type="submit" class="btn btn-info" id="auto-map-btn" disabled>
                        <i class="fas fa-magic"></i> {% trans "Auto-Map Concepts" %}
                    </button>
                </form>
            </div>
        </div>
    </div>
</div>

<!-- Organizational Unit Configuration -->
<div class="row">
    <div class="col-12">
        <div class="card mb-4">
            <div class="card-header bg-secondary text-white">
                <h5 class="mb-0"><i class="fas fa-building"></i> {% trans "Organizational Unit Configuration" %}</h5>
            </div>
            <div class="card-body">
                <p class="text-muted">{% trans "Configure how organizational units are identified for scope filtering in the graph." %}</p>
                <div class="row">
                    <div class="col-md-6">
                        <label class="form-label"><strong>{% trans "Org Unit Concept Name:" %}</strong></label>
                        <p>{{ presets.org_unit_config.concept_name|default:"Organisation Unit" }}</p>
                    </div>
                    <div class="col-md-6">
                        <label class="form-label"><strong>{% trans "Ownership Relationship:" %}</strong></label>
                        <p>{{ presets.org_unit_config.ownership_relation|default:"ownedBy" }}</p>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Raw JSON Editor (Advanced) -->
<div class="row">
    <div class="col-12">
        <div class="card">
            <div class="card-header bg-dark text-white">
                <h5 class="mb-0">
                    <button class="btn btn-link text-white text-decoration-none" type="button" data-bs-toggle="collapse" data-bs-target="#json-editor-collapse">
                        <i class="fas fa-code"></i> {% trans "Advanced: Raw JSON Editor" %}
                    </button>
                </h5>
            </div>
            <div id="json-editor-collapse" class="collapse">
                <div class="card-body">
                    <p class="text-muted small">{% trans "Edit the raw JSON configuration. Be careful - invalid JSON will be rejected." %}</p>
                    <form method="POST" action="{% url 'graph_presets_update' organisation.id %}">
                        {% csrf_token %}
                        <div class="mb-3">
                            <textarea name="presets_json" class="form-control font-monospace" rows="20" style="font-size: 12px;">{{ presets_json }}</textarea>
                        </div>
                        <button type="submit" class="btn btn-primary">
                            <i class="fas fa-save"></i> {% trans "Save Configuration" %}
                        </button>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
$(document).ready(function() {
    // Enable auto-map button when model is selected
    $('#model-select').change(function() {
        var modelId = $(this).val();
        $('#auto-map-btn').prop('disabled', !modelId);
        if (modelId) {
            $('#auto-map-form').attr('action', '{% url "graph_presets_list" organisation.id %}auto_map/' + modelId + '/');
        }
    });
});
</script>

{% endblock content %}
